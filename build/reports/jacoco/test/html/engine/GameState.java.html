<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameState.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">space_Invaders</a> &gt; <a href="index.source.html" class="el_package">engine</a> &gt; <span class="el_source">GameState.java</span></div><h1>GameState.java</h1><pre class="source lang-java linenums">// engine/GameState.java
package engine;

import java.util.HashMap;
import java.util.Map;

import engine.gameplay.item.ItemEffect;
import engine.gameplay.item.ItemEffect.ItemEffectType;
import engine.utils.Cooldown;

/**
 * Implements an object that stores the state of the game between levels -
 * supports 2-player co-op with shared lives.
 *
 * @author &lt;a href=&quot;mailto:RobertoIA1987@gmail.com&quot;&gt;Roberto Izquierdo Amo&lt;/a&gt;
 *
 *
 */
public class GameState {

<span class="nc" id="L21">    private static final java.util.logging.Logger logger = Core.getLogger();</span>

    // 2P mode: number of players used for shared lives in co-op
	public static final int NUM_PLAYERS = 2; // adjust later if needed

	// 2P mode: true if in co-op mode
	private final boolean coop;

	/** Current game level. */
	private int level;

	// 2P mode: if true, lives are shared in a team pool; else per-player lives
	private final boolean sharedLives;

	// team life pool and cap (used when sharedLives == true).
	private int teamLives;
	private int teamLivesCap;

	/** Current coin count. */ // ADD THIS LINE
<span class="nc" id="L40">    private static int coins = 0; // ADD THIS LINE - edited for 2P mode</span>

    private static class EffectState {
        Cooldown cooldown;
        boolean active;
        Integer effectValue;

<span class="nc" id="L47">        EffectState() {</span>
<span class="nc" id="L48">            this.cooldown = null;</span>
<span class="nc" id="L49">            this.active = false;</span>
<span class="nc" id="L50">            this.effectValue = null;</span>
<span class="nc" id="L51">        }</span>
    }

    /** Each player has all effect types always initialized (inactive at start). */
<span class="nc" id="L55">    private final Map&lt;Integer, Map&lt;ItemEffectType, EffectState&gt;&gt; playerEffects = new HashMap&lt;&gt;();</span>

	// 2P mode: co-op aware constructor used by the updated Core loop - livesEach
	// applies per-player; co-op uses shared pool.
<span class="nc" id="L59">	public GameState(final int level, final int livesEach, final boolean coop, final int coin) {</span>
<span class="nc" id="L60">		this.level = level;</span>
<span class="nc" id="L61">		this.coop = coop;</span>
<span class="nc" id="L62">        this.coins = coin;</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (coop) {</span>
<span class="nc" id="L65">			this.sharedLives = true;</span>
<span class="nc" id="L66">			this.teamLives = Math.max(0, livesEach * NUM_PLAYERS);</span>
<span class="nc" id="L67">			this.teamLivesCap = this.teamLives;</span>
		} else {
<span class="nc" id="L69">			this.sharedLives = false;</span>
<span class="nc" id="L70">			this.teamLives = 0;</span>
<span class="nc" id="L71">			this.teamLivesCap = 0;</span>
			// legacy: put all lives on P1
<span class="nc" id="L73">			lives[0] = Math.max(0, livesEach);</span>
		}

<span class="nc" id="L76">        initializeEffectStates();</span>
<span class="nc" id="L77">    }</span>

	// 2P mode: per-player tallies (used for stats/scoring; lives[] unused in shared
	// mode).
<span class="nc" id="L81">	private final int[] score = new int[NUM_PLAYERS];</span>
<span class="nc" id="L82">	private final int[] lives = new int[NUM_PLAYERS];</span>
<span class="nc" id="L83">	private final int[] bulletsShot = new int[NUM_PLAYERS];</span>
<span class="nc" id="L84">	private final int[] shipsDestroyed = new int[NUM_PLAYERS];</span>

	/* ---------- Constructors ---------- */

	/** Legacy 6-arg - kept for old call sites */
	/**
	 * Constructor.
	 *
	 * @param level
	 *                       Current game level.
	 * @param score
	 *                       Current score.
	 * @param livesRemaining
	 *                       Lives currently remaining.
	 * @param bulletsShot
	 *                       Bullets shot until now.
	 * @param shipsDestroyed
	 *                       Ships destroyed until now.
	 * @param coins          // ADD THIS LINE
	 *                       Current coin count. // ADD THIS LINE
	 */
	public GameState(final int level, final int score,
					 final int livesRemaining, final int bulletsShot,
<span class="nc" id="L107">					 final int shipsDestroyed, final int coins) { // MODIFY THIS LINE</span>
<span class="nc" id="L108">		this.level = level;</span>
<span class="nc" id="L109">		this.sharedLives = false;</span>
<span class="nc" id="L110">		this.teamLives = 0;</span>
<span class="nc" id="L111">		this.teamLivesCap = 0;</span>

<span class="nc" id="L113">		this.score[0] = score;</span>
<span class="nc" id="L114">		this.lives[0] = livesRemaining;</span>
<span class="nc" id="L115">		this.bulletsShot[0] = bulletsShot;</span>
<span class="nc" id="L116">		this.shipsDestroyed[0] = shipsDestroyed;</span>

<span class="nc" id="L118">		this.coins = coins; // ADD THIS LINE - edited for 2P mode</span>
<span class="nc" id="L119">		this.coop = false; // 2P: single-player mode</span>

<span class="nc" id="L121">        initializeEffectStates();</span>
<span class="nc" id="L122">    }</span>

	/* ------- 2P mode: aggregate totals used by Core/ScoreScreen/UI------- */
	public int getScore() {
<span class="nc" id="L126">		int t = 0;</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">		for (int p = 0; p &lt; NUM_PLAYERS; p++)</span>
<span class="nc" id="L128">			t += score[p];</span>
<span class="nc" id="L129">		return t;</span>
	}

	public int getLivesRemaining() {
<span class="nc bnc" id="L133" title="All 2 branches missed.">		return sharedLives ? teamLives : (lives[0] + lives[1]);</span>
	}

	public int getBulletsShot() {
<span class="nc" id="L137">		int t = 0;</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">		for (int p = 0; p &lt; NUM_PLAYERS; p++)</span>
<span class="nc" id="L139">			t += bulletsShot[p];</span>
<span class="nc" id="L140">		return t;</span>
	}

	public int getShipsDestroyed() {
<span class="nc" id="L144">		int t = 0;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">		for (int p = 0; p &lt; NUM_PLAYERS; p++)</span>
<span class="nc" id="L146">			t += shipsDestroyed[p];</span>
<span class="nc" id="L147">		return t;</span>

	}


	/* ----- Per-player getters (needed by Score.java) ----- */
	public int getScore(final int p) {
<span class="nc bnc" id="L154" title="All 4 branches missed.">		return (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS) ? score[p] : 0;</span>
	}

	public int getBulletsShot(final int p) {
<span class="nc bnc" id="L158" title="All 4 branches missed.">		return (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS) ? bulletsShot[p] : 0;</span>
	}

	public int getShipsDestroyed(final int p) {
<span class="nc bnc" id="L162" title="All 4 branches missed.">		return (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS) ? shipsDestroyed[p] : 0;</span>
	}

	public void addScore(final int p, final int delta) {
<span class="nc" id="L166">		int realDelta = delta;</span>
		// If ScoreBoost item active, score gain is doubled.
<span class="nc" id="L168">        Integer multiplier = getEffectValue(p, ItemEffect.ItemEffectType.SCOREBOOST);</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">        if (multiplier != null) {</span>
<span class="nc" id="L170">            realDelta = delta * multiplier;</span>
<span class="nc" id="L171">            logger.info(&quot;[GameState] Player &quot; + (p + 1) + &quot; ScoreBoost active (x&quot; + multiplier + &quot;). Score changed from &quot; + delta + &quot; to &quot; + realDelta);</span>
        }
<span class="nc" id="L173">		score[p] += realDelta;</span>
<span class="nc" id="L174">	}</span>

	public void incBulletsShot(final int p) {
<span class="nc" id="L177">		bulletsShot[p]++;</span>
<span class="nc" id="L178">	}</span>

	public void incShipsDestroyed(final int p) {
<span class="nc" id="L181">		shipsDestroyed[p]++;</span>
<span class="nc" id="L182">	}</span>

<span class="nc" id="L184">    public boolean getCoop() { return this.coop; }</span>

	// 2P mode: per-player coin tracking
<span class="nc" id="L187">    public int getCoins() { return coins; } // legacy total for ScoreScreen</span>

    public void addCoins(final int p, final int delta) {
<span class="nc bnc" id="L190" title="All 6 branches missed.">        if (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS &amp;&amp; delta &gt; 0)</span>
<span class="nc" id="L191">            coins = Math.max(0, coins + delta);</span>
<span class="nc" id="L192">    }</span>

    public boolean spendCoins(final int p, final int amount) {
<span class="nc bnc" id="L195" title="All 6 branches missed.">        if (p &lt; 0 || p &gt;= NUM_PLAYERS || amount &lt; 0) return false;</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (coins &lt; amount) return false;</span>
<span class="nc" id="L197">        coins -= amount;</span>
<span class="nc" id="L198">        return true;</span>
    }

	// ===== Mode / life-pool helpers expected elsewhere =====
	public boolean isCoop() {
<span class="nc" id="L203">		return coop;</span>
	}

	public boolean isSharedLives() {
<span class="nc" id="L207">		return sharedLives;</span>
	}

	public int getTeamLives() {
<span class="nc" id="L211">		return teamLives;</span>
	}

	public void addTeamLife(final int n) {
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (sharedLives)</span>
<span class="nc" id="L216">			teamLives = Math.min(teamLivesCap, teamLives + Math.max(0, n));</span>
<span class="nc" id="L217">	}</span>

	private void decTeamLife(final int n) {
<span class="nc bnc" id="L220" title="All 2 branches missed.">		if (sharedLives)</span>
<span class="nc" id="L221">			teamLives = Math.max(0, teamLives - Math.max(0, n));</span>
<span class="nc" id="L222">	}</span>

    // 2P mode: decrement life (shared pool if enabled; otherwise per player). */
    public void decLife(final int p) {
<span class="nc bnc" id="L226" title="All 2 branches missed.">        if (sharedLives) {</span>
<span class="nc" id="L227">            decTeamLife(1);</span>
<span class="nc bnc" id="L228" title="All 6 branches missed.">        } else if (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS &amp;&amp; lives[p] &gt; 0) {</span>
<span class="nc" id="L229">            lives[p]--;</span>
        }
<span class="nc" id="L231">    }</span>

    // for bonusLife, balance out decLife (+/- life)
    public void addLife(final int p, final int n) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (sharedLives) {</span>
<span class="nc" id="L236">            addTeamLife(n);</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">        } else if (p &gt;= 0 &amp;&amp; p &lt; NUM_PLAYERS) {</span>
<span class="nc" id="L238">            lives[p] = Math.max(0, lives[p] + Math.max(0, n));</span>
        }
<span class="nc" id="L240">    }</span>


    public int getLevel() {
<span class="nc" id="L244">		return level;</span>
	}

	public void nextLevel() {
<span class="nc" id="L248">		level++;</span>
<span class="nc" id="L249">	}</span>

	// Team alive if pool &gt; 0 (shared) or any player has lives (separate).
	public boolean teamAlive() {
<span class="nc bnc" id="L253" title="All 8 branches missed.">		return sharedLives ? (teamLives &gt; 0) : (lives[0] &gt; 0 || lives[1] &gt; 0);</span>
	}

	// for ItemEffect.java
	public int getTeamLivesCap() {
<span class="nc" id="L258">		return teamLivesCap;</span>
	}

	// for ItemEffect.java
	public int get1PlayerLives() {

<span class="nc" id="L264">		return lives[0];</span>
	}

    /** ---------- Item effects status methods ---------- **/

    /** Initialize all possible effects for every player (inactive). */
    private void initializeEffectStates() {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        for (int p = 0; p &lt; NUM_PLAYERS; p++) {</span>
<span class="nc" id="L272">            Map&lt;ItemEffectType, EffectState&gt; effectMap = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">            for (ItemEffectType type : ItemEffectType.values()) {</span>
<span class="nc" id="L274">                effectMap.put(type, new EffectState());</span>
            }
<span class="nc" id="L276">            playerEffects.put(p, effectMap);</span>
        }
<span class="nc" id="L278">    }</span>

    public void addEffect(int playerIndex, ItemEffectType type, Integer effectValue, int durationSeconds) {
<span class="nc bnc" id="L281" title="All 4 branches missed.">        if (playerIndex &lt; 0 || playerIndex &gt;= NUM_PLAYERS) return;</span>

<span class="nc" id="L283">        Map&lt;ItemEffectType, EffectState&gt; effects = playerEffects.get(playerIndex);</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (effects == null) return;</span>

<span class="nc" id="L286">        EffectState state = effects.get(type);</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (state == null) return;</span>

<span class="nc bnc" id="L289" title="All 2 branches missed.">        String valueStr = (effectValue != null) ? &quot; (value: &quot; + effectValue + &quot;)&quot; : &quot;&quot;;</span>

<span class="nc bnc" id="L291" title="All 4 branches missed.">        if (state.active &amp;&amp; state.cooldown != null) {</span>
            // Extend existing effect
<span class="nc" id="L293">            state.cooldown.addTime(durationSeconds * 1000);</span>

<span class="nc" id="L295">            state.effectValue = effectValue;</span>

<span class="nc" id="L297">            logger.info(&quot;[GameState] Player &quot; + playerIndex + &quot; extended &quot; + type</span>
<span class="nc" id="L298">                    + valueStr + &quot;) by &quot; + durationSeconds + &quot;s to &quot; + state.cooldown.getDuration() );</span>
        } else {
            // Start new effect
<span class="nc" id="L301">            state.cooldown = Core.getCooldown(durationSeconds * 1000);</span>
<span class="nc" id="L302">            state.cooldown.reset();</span>
<span class="nc" id="L303">            state.active = true;</span>

<span class="nc" id="L305">            state.effectValue = effectValue;</span>

<span class="nc" id="L307">            logger.info(&quot;[GameState] Player &quot; + playerIndex + &quot; started &quot; + type</span>
                    + valueStr + &quot;) for &quot; + durationSeconds + &quot;s&quot;);
        }
<span class="nc" id="L310">    }</span>

    public boolean hasEffect(int playerIndex, ItemEffectType type) {
<span class="nc bnc" id="L313" title="All 4 branches missed.">        if (playerIndex &lt; 0 || playerIndex &gt;= NUM_PLAYERS) return false;</span>

<span class="nc" id="L315">        Map&lt;ItemEffectType, EffectState&gt; effects = playerEffects.get(playerIndex);</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">        if (effects == null) return false;</span>

<span class="nc" id="L318">        EffectState state = effects.get(type);</span>
<span class="nc bnc" id="L319" title="All 4 branches missed.">        if (state == null || !state.active) return false;</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">        return !state.cooldown.checkFinished();</span>
    }

    /**
     * Gets the effect value for a specific player and effect type
     *
     * @param playerIndex
     *            Index of the player (0 or 1)
     * @param type
     *            Type of effect to check
     * @return
     *            Effect value if active, null otherwise
     */
    public Integer getEffectValue(int playerIndex, ItemEffectType type) {
<span class="nc bnc" id="L335" title="All 4 branches missed.">        if (playerIndex &lt; 0 || playerIndex &gt;= NUM_PLAYERS) return null;</span>

<span class="nc" id="L337">        Map&lt;ItemEffectType, EffectState&gt; effects = playerEffects.get(playerIndex);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (effects == null) return null;</span>

<span class="nc" id="L340">        EffectState state = effects.get(type);</span>
<span class="nc bnc" id="L341" title="All 4 branches missed.">        if (state == null || !state.active) return null;</span>

        // Check if effect is still valid (not expired)
<span class="nc bnc" id="L344" title="All 4 branches missed.">        if (state.cooldown != null &amp;&amp; state.cooldown.checkFinished()) {</span>
<span class="nc" id="L345">            return null;</span>
        }

<span class="nc" id="L348">        return state.effectValue;</span>
    }

    /** Call this each frame to clean up expired effects */
    public void updateEffects() {
<span class="nc bnc" id="L353" title="All 2 branches missed.">        for (int p = 0; p &lt; NUM_PLAYERS; p++) {</span>
<span class="nc" id="L354">            Map&lt;ItemEffectType, EffectState&gt; effects = playerEffects.get(p);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">            if (effects == null) continue;</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">            for (Map.Entry&lt;ItemEffectType, EffectState&gt; entry : effects.entrySet()) {</span>
<span class="nc" id="L358">                EffectState state = entry.getValue();</span>
<span class="nc bnc" id="L359" title="All 6 branches missed.">                if (state.active &amp;&amp; state.cooldown != null &amp;&amp; state.cooldown.checkFinished()) {</span>
<span class="nc" id="L360">                    logger.info(&quot;[GameState] Player &quot; + p + &quot; effect &quot; + entry.getKey() + &quot; expired.&quot;);</span>
<span class="nc" id="L361">                    state.active = false;</span>
<span class="nc" id="L362">                    state.cooldown = null;  // Release reference</span>
<span class="nc" id="L363">                    state.effectValue = null;</span>
                }
<span class="nc" id="L365">            }</span>
        }
<span class="nc" id="L367">    }</span>

    /** Clear all active effects for a specific player */
    public void clearEffects(int playerIndex) {
        //
<span class="nc bnc" id="L372" title="All 4 branches missed.">        if (playerIndex &lt; 0 || playerIndex &gt;= NUM_PLAYERS) return;</span>

<span class="nc" id="L374">        Map&lt;ItemEffectType, EffectState&gt; effects = playerEffects.get(playerIndex);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (effects == null) return;</span>

        // for - all effect types for this player
<span class="nc bnc" id="L378" title="All 2 branches missed.">        for (Map.Entry&lt;ItemEffectType, EffectState&gt; entry : effects.entrySet()) {</span>
            // get effect state
<span class="nc" id="L380">            EffectState state = entry.getValue();</span>
            // if state active then false
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (state.active) {</span>
<span class="nc" id="L383">                state.active = false;</span>
<span class="nc" id="L384">                state.cooldown = null;</span>
<span class="nc" id="L385">                state.effectValue = null;</span>
            }
<span class="nc" id="L387">        }</span>
<span class="nc" id="L388">        logger.info(&quot;[GameState] Player &quot; + playerIndex + &quot;: All effects cleared.&quot;);</span>
<span class="nc" id="L389">    }</span>

    /** Clear all active effects for all players */
    public void clearAllEffects() {
<span class="nc bnc" id="L393" title="All 2 branches missed.">        for (int p = 0; p &lt; NUM_PLAYERS; p++) {</span>
<span class="nc" id="L394">            clearEffects(p);</span>
        }
<span class="nc" id="L396">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>