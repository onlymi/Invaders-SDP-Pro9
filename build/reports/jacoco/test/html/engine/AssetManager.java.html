<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AssetManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">space_Invaders</a> &gt; <a href="index.source.html" class="el_package">engine</a> &gt; <span class="el_source">AssetManager.java</span></div><h1>AssetManager.java</h1><pre class="source lang-java linenums">package engine;

import engine.gameplay.achievement.Achievement;

import javax.sound.sampled.*;
import java.awt.Font;
import java.awt.FontFormatException;
import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.*;
import java.util.logging.Logger;

/**
 * 게임에 필요한 모든 Asset(스프라이트, 폰트 등)을 로드하고 저장 및 관리하는 클래스
 */
public final class AssetManager {

    /**
     * 6개의 그래픽 소스 파일을 구분하기 위한 Enum
     */
<span class="fc" id="L21">    private enum SourceCategory {</span>
<span class="fc" id="L22">        PLAYER(&quot;graphics/player_graphics&quot;),</span>
<span class="fc" id="L23">        ENEMY(&quot;graphics/enemy_graphics&quot;),</span>
<span class="fc" id="L24">        BOSS(&quot;graphics/boss_graphics&quot;),</span>
<span class="fc" id="L25">        BULLET(&quot;graphics/bullet_graphics&quot;),</span>
<span class="fc" id="L26">        MUTUAL(&quot;graphics/mutual_graphics&quot;),</span>
<span class="fc" id="L27">        ITEM(&quot;graphics/item_graphics&quot;);</span>

        private final String filePath;
<span class="fc" id="L30">        SourceCategory(String path) { this.filePath = path; }</span>
<span class="nc" id="L31">        public String getFilePath() { return this.filePath; }</span>
    }

    /** Sprite types. */
<span class="fc" id="L35">    public enum SpriteType {</span>
        /** Player ship. */
<span class="fc" id="L37">        Ship1(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L38">        Ship2(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L39">        Ship3(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L40">        Ship4(SourceCategory.PLAYER, 13, 8),</span>
        /** Destroyed player ship. */
<span class="fc" id="L42">        ShipDestroyed1(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L43">        ShipDestroyed2(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L44">        ShipDestroyed3(SourceCategory.PLAYER, 13, 8),</span>
<span class="fc" id="L45">        ShipDestroyed4(SourceCategory.PLAYER, 13, 8),</span>
        /** Player bullet. */
<span class="fc" id="L47">        Bullet(SourceCategory.BULLET, 3, 5),</span>
        /** Enemy bullet. */
<span class="fc" id="L49">        EnemyBullet(SourceCategory.BULLET, 3, 5),</span>
        /** First enemy ship - first form. */
<span class="fc" id="L51">        EnemyShipA1(SourceCategory.ENEMY, 12, 8),</span>
        /** First enemy ship - second form. */
<span class="fc" id="L53">        EnemyShipA2(SourceCategory.ENEMY, 12, 8),</span>
        /** Second enemy ship - first form. */
<span class="fc" id="L55">        EnemyShipB1(SourceCategory.ENEMY, 12, 8),</span>
        /** Second enemy ship - second form. */
<span class="fc" id="L57">        EnemyShipB2(SourceCategory.ENEMY, 12, 8),</span>
        /** Third enemy ship - first form. */
<span class="fc" id="L59">        EnemyShipC1(SourceCategory.ENEMY, 12, 8),</span>
        /** Third enemy ship - second form. */
<span class="fc" id="L61">        EnemyShipC2(SourceCategory.ENEMY, 12, 8),</span>
        /** Bonus ship. */
<span class="fc" id="L63">        EnemyShipSpecial(SourceCategory.ENEMY, 16, 7),</span>
        /** Boss ship. */
<span class="fc" id="L65">        BossEnemy1(SourceCategory.BOSS, 21, 10),</span>
<span class="fc" id="L66">        BossEnemy2(SourceCategory.BOSS, 21, 10),</span>
<span class="fc" id="L67">        BossEnemy3(SourceCategory.BOSS, 21, 10),</span>
        /** Destroyed enemy ship. */
<span class="fc" id="L69">        Explosion(SourceCategory.MUTUAL, 13, 7),</span>
        /** Heart for lives display. */
<span class="fc" id="L71">        Heart(SourceCategory.MUTUAL, 11, 10),</span>
        /** Item Graphics Temp */
<span class="fc" id="L73">        ItemScore(SourceCategory.ITEM, 5, 5),</span>
<span class="fc" id="L74">        ItemCoin(SourceCategory.ITEM, 5, 5),</span>
<span class="fc" id="L75">        ItemHeal(SourceCategory.ITEM, 5, 5),</span>
<span class="fc" id="L76">        ItemTripleShot(SourceCategory.ITEM, 5, 7),</span>
<span class="fc" id="L77">        ItemScoreBooster(SourceCategory.ITEM, 5, 5),</span>
<span class="fc" id="L78">        ItemBulletSpeedUp(SourceCategory.ITEM, 5, 5);</span>

        // Enum이 자신의 정보를 저장할 변수들
        private final SourceCategory category;
        private final int width;
        private final int height;

        // Enum 생성자
<span class="fc" id="L86">        SpriteType(SourceCategory category, int width, int height) {</span>
<span class="fc" id="L87">            this.category = category;</span>
<span class="fc" id="L88">            this.width = width;</span>
<span class="fc" id="L89">            this.height = height;</span>
<span class="fc" id="L90">        }</span>

        // Getter 메서드
<span class="nc" id="L93">        public SourceCategory getCategory() { return this.category; }</span>
<span class="nc" id="L94">        public int getWidth() { return this.width; }</span>
<span class="nc" id="L95">        public int getHeight() { return this.height; }</span>
    };

    private static AssetManager instance;
<span class="nc" id="L99">    private static final Logger LOGGER = Core.getLogger();</span>
<span class="nc" id="L100">    private static final FileManager fileManager = Core.getFileManager();;</span>

    Map&lt;SpriteType, boolean[][]&gt; spriteMap;
    HashMap&lt;String, Clip&gt; soundMap;
    private Font fontRegular;
    private Font fontBig;

<span class="nc" id="L107">    private AssetManager() {</span>
<span class="nc" id="L108">        LOGGER.info(&quot;Started loading resources.&quot;);</span>

        try {
<span class="nc" id="L111">            spriteMap = new LinkedHashMap&lt;SpriteType, boolean[][]&gt;();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            for (SpriteType type : SpriteType.values()) {</span>
<span class="nc" id="L113">                spriteMap.put(type, new boolean[type.getWidth()][type.getHeight()]);</span>
            }
            // Sprite graphics loading
<span class="nc" id="L116">            this.loadSprite(spriteMap);</span>
<span class="nc" id="L117">            LOGGER.info(&quot;Finished loading the sprites.&quot;);</span>

            // Font loading
<span class="nc" id="L120">            fontRegular = this.loadFont(14f);</span>
<span class="nc" id="L121">            fontBig = this.loadFont(24f);</span>
<span class="nc" id="L122">            LOGGER.info(&quot;Finished loading the fonts.&quot;);</span>

<span class="nc" id="L124">        } catch (IOException e) {</span>
<span class="nc" id="L125">            LOGGER.warning(&quot;Loading failed.&quot;);</span>
<span class="nc" id="L126">        } catch (FontFormatException e) {</span>
<span class="nc" id="L127">            LOGGER.warning(&quot;Font formating failed.&quot;);</span>
<span class="nc" id="L128">        }</span>

        try {
<span class="nc" id="L131">            soundMap = new HashMap&lt;String, Clip&gt;();</span>
            // 모든 사운드 파일을 미리 로드
<span class="nc" id="L133">            soundMap.put(&quot;title_sound&quot;, loadSound(&quot;sound/title_sound.wav&quot;));</span>
<span class="nc" id="L134">            soundMap.put(&quot;game_theme&quot;, loadSound(&quot;sound/game_theme.wav&quot;));</span>
<span class="nc" id="L135">            soundMap.put(&quot;select&quot;, loadSound(&quot;sound/select.wav&quot;));</span>
<span class="nc" id="L136">            soundMap.put(&quot;hover&quot;, loadSound(&quot;sound/hover.wav&quot;));</span>
<span class="nc" id="L137">            soundMap.put(&quot;count_down_sound&quot;, loadSound(&quot;sound/count_down_sound.wav&quot;));</span>
<span class="nc" id="L138">            soundMap.put(&quot;shoot_enemies&quot;, loadSound(&quot;sound/shoot_enemies.wav&quot;));</span>
<span class="nc" id="L139">            soundMap.put(&quot;invader_killed&quot;, loadSound(&quot;sound/invader_killed.wav&quot;));</span>
<span class="nc" id="L140">            soundMap.put(&quot;achievement&quot;, loadSound(&quot;sound/achievement.wav&quot;));</span>
<span class="nc" id="L141">            soundMap.put(&quot;shoot&quot;, loadSound(&quot;sound/shoot.wav&quot;));</span>
<span class="nc" id="L142">            soundMap.put(&quot;shooting&quot;, loadSound(&quot;sound/shooting.wav&quot;));</span>
<span class="nc" id="L143">            soundMap.put(&quot;explosion&quot;, loadSound(&quot;sound/explosion.wav&quot;));</span>
<span class="nc" id="L144">            soundMap.put(&quot;special_ship_sound&quot;, loadSound(&quot;sound/special_ship_sound.wav&quot;));</span>
<span class="nc" id="L145">            soundMap.put(&quot;win&quot;, loadSound(&quot;sound/win.wav&quot;));</span>
<span class="nc" id="L146">            soundMap.put(&quot;lose&quot;, loadSound(&quot;sound/lose.wav&quot;));</span>

<span class="nc" id="L148">            LOGGER.info(&quot;Finished loading the sounds.&quot;);</span>
<span class="nc" id="L149">        } catch (Exception e) {</span>
<span class="nc" id="L150">            LOGGER.warning(&quot;Sound loading failed.&quot;);</span>
<span class="nc" id="L151">        }</span>
<span class="nc" id="L152">    }</span>

    /**
     * Returns shared instance of AssetManager.
     *
     * @return Shared instance of AssetManager.
     */
    public static AssetManager getInstance() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">        if (instance == null)</span>
<span class="nc" id="L161">            instance = new AssetManager();</span>
<span class="nc" id="L162">        return instance;</span>
    }

    /**
     * Loads a font of a given size.
     *
     * @param size
     *            Point size of the font.
     * @return New font.
     * @throws IOException
     *             In case of loading problems.
     * @throws FontFormatException
     *             In case of incorrect font format.
     */
    public Font loadFont(final float size) throws IOException,
            FontFormatException {
<span class="nc" id="L178">        InputStream inputStream = null;</span>
        Font font;

        try {
            // Font loading.
<span class="nc" id="L183">            inputStream = FileManager.class.getClassLoader().getResourceAsStream(&quot;font/font.ttf&quot;);</span>
<span class="nc" id="L184">            font = Font.createFont(Font.TRUETYPE_FONT, inputStream).deriveFont(</span>
                    size);
        } finally {
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (inputStream != null)</span>
<span class="nc" id="L188">                inputStream.close();</span>
        }

<span class="nc" id="L191">        return font;</span>
    }

    /**
     * Loads sprites from disk.
     *
     * @param spriteMap
     *            Mapping of sprite type and empty boolean matrix that will
     *            contain the image.
     * @throws IOException
     *             In case of loading problems.
     */
    public void loadSprite(final Map&lt;SpriteType, boolean[][]&gt; spriteMap) throws IOException {
<span class="nc" id="L204">        Map&lt;SourceCategory, InputStream&gt; streamMap = new EnumMap&lt;&gt;(SourceCategory.class);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (SourceCategory category: SourceCategory.values()) {</span>
<span class="nc" id="L206">            streamMap.put(category, AssetManager.class.getClassLoader().getResourceAsStream(category.getFilePath()));</span>
        }

        try {
            char c;
<span class="nc bnc" id="L211" title="All 2 branches missed.">            for (Map.Entry&lt;SpriteType, boolean[][]&gt; sprite : spriteMap.entrySet()) {</span>
<span class="nc" id="L212">                SpriteType type = sprite.getKey();</span>
<span class="nc" id="L213">                boolean[][] data = sprite.getValue();</span>
<span class="nc" id="L214">                InputStream selectedStream = streamMap.get(type.getCategory());</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">                for (int i = 0; i &lt; sprite.getValue().length; i++)</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">                    for (int j = 0; j &lt; sprite.getValue()[i].length; j++) {</span>
                        do {
<span class="nc" id="L218">                            c = (char) selectedStream.read();</span>
<span class="nc bnc" id="L219" title="All 4 branches missed.">                        } while (c != '0' &amp;&amp; c != '1');</span>

<span class="nc bnc" id="L221" title="All 2 branches missed.">                        data[i][j] = (c == '1');</span>
                    }
<span class="nc" id="L223">                LOGGER.fine(&quot;Sprite &quot; + sprite.getKey() + &quot; loaded.&quot;);</span>
<span class="nc" id="L224">            }</span>
        } finally {
<span class="nc bnc" id="L226" title="All 2 branches missed.">            for (InputStream stream: streamMap.values()) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                if (stream != null)</span>
<span class="nc" id="L228">                    stream.close();</span>
<span class="nc" id="L229">            }</span>
        }
<span class="nc" id="L231">    }</span>

    /**
     * 지정된 리소스 경로에서 오디오 파일을 읽어와 재생 준비가 완료된 Clip 객체로 반환합니다.
     *
     * @param resourcePath 리소스 폴더 내의 사운드 파일 경로 (예: &quot;sound/shoot.wav&quot;)
     * @return 메모리에 로드된 Clip 객체
     * @throws UnsupportedAudioFileException 오디오 파일 형식이 지원되지 않는 경우
     * @throws IOException 파일 입출력 오류가 발생한 경우
     * @throws LineUnavailableException 오디오 라인을 열 수 없는 경우
     */
    private Clip loadSound(String resourcePath) throws UnsupportedAudioFileException, IOException, LineUnavailableException {
<span class="nc" id="L243">        AudioInputStream audioStream = openAudioStream(resourcePath);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (audioStream == null) {</span>
<span class="nc" id="L245">            throw new FileNotFoundException(&quot;Audio resource not found: &quot; + resourcePath);</span>
        }

<span class="nc" id="L248">        audioStream = toPcmSigned(audioStream);</span>

<span class="nc" id="L250">        DataLine.Info info = new DataLine.Info(Clip.class, audioStream.getFormat());</span>
<span class="nc" id="L251">        Clip clip = (Clip) AudioSystem.getLine(info);</span>
<span class="nc" id="L252">        clip.open(audioStream);</span>

<span class="nc" id="L254">        return clip;</span>
    }

    /** Opens an audio stream from classpath resources or absolute/relative file path. */
    private static AudioInputStream openAudioStream(String resourcePath)
            throws UnsupportedAudioFileException, IOException {
<span class="nc" id="L260">        InputStream in = SoundManager.class.getClassLoader().getResourceAsStream(resourcePath);</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (in != null) {</span>
<span class="nc" id="L262">            return AudioSystem.getAudioInputStream(in);</span>
        }
        // Fallback to file system path for developer/local runs
<span class="nc" id="L265">        try (FileInputStream fis = new FileInputStream(resourcePath)) {</span>
<span class="nc" id="L266">            return AudioSystem.getAudioInputStream(fis);</span>
<span class="nc" id="L267">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L268">            LOGGER.fine(&quot;Audio resource not found: &quot; + resourcePath);</span>
<span class="nc" id="L269">            return null;</span>
        }
    }

    /** Ensures the audio stream is PCM_SIGNED for Clip compatibility on all JVMs. */
    public static AudioInputStream toPcmSigned(AudioInputStream source) throws UnsupportedAudioFileException, IOException {
<span class="nc" id="L275">        AudioFormat format = source.getFormat();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (format.getEncoding() == AudioFormat.Encoding.PCM_SIGNED) {</span>
<span class="nc" id="L277">            return source;</span>
        }

<span class="nc" id="L280">        AudioFormat targetFormat = new AudioFormat(</span>
                AudioFormat.Encoding.PCM_SIGNED,
<span class="nc" id="L282">                format.getSampleRate(),</span>
                16,
<span class="nc" id="L284">                format.getChannels(),</span>
<span class="nc" id="L285">                format.getChannels() * 2,</span>
<span class="nc" id="L286">                format.getSampleRate(),</span>
                false
        );
<span class="nc" id="L289">        return AudioSystem.getAudioInputStream(targetFormat, source);</span>
    }

    public Clip getSound(String soundName) {
<span class="nc" id="L293">        return soundMap.get(soundName);</span>
    }

    public boolean[][] getSprite(SpriteType type) {
<span class="nc" id="L297">        return spriteMap.get(type);</span>
    }

    public Font getFontRegular() {
<span class="nc" id="L301">        return fontRegular;</span>
    }

    public Font getFontBig() {
<span class="nc" id="L305">        return fontBig;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>