<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Core.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">space_Invaders</a> &gt; <a href="index.source.html" class="el_package">engine</a> &gt; <span class="el_source">Core.java</span></div><h1>Core.java</h1><pre class="source lang-java linenums">package engine;

import java.io.IOException;
import java.util.List;
import java.util.logging.ConsoleHandler;
import java.util.logging.FileHandler;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;

import engine.gameplay.achievement.AchievementManager;
import engine.hitbox.HitboxManager;
import engine.utils.Cooldown;
import engine.utils.MinimalFormatter;
import screen.*;
import entity.Ship;


/**
 * Implements core game logic.
 *
 * @author &lt;a href=&quot;mailto:RobertoIA1987@gmail.com&quot;&gt;Roberto Izquierdo Amo&lt;/a&gt;
 *
 */
public final class Core {

    private static final int WIDTH = 448;
    private static final int HEIGHT = 520;
    private static final int FPS = 60;

    /** Lives per player (used to compute team pool in shared mode). */
    private static final int MAX_LIVES = 3;
    private static final int EXTRA_LIFE_FREQUENCY = 3;

    /** Frame to draw the screen on. */
    private static Frame frame;
    private static Screen currentScreen;
    private static List&lt;GameSettings&gt; gameSettings;
<span class="fc" id="L39">    private static final Logger LOGGER = Logger.getLogger(Core.class.getSimpleName());</span>
    private static Handler fileHandler;
    private static ConsoleHandler consoleHandler;

    /**
     * Test implementation.
     *
     * @param args
     *             Program args, ignored.
     */
    public static void main(final String[] args) throws IOException {
        try {
<span class="nc" id="L51">            LOGGER.setUseParentHandlers(false);</span>
<span class="nc" id="L52">            fileHandler = new FileHandler(&quot;log&quot;);</span>
<span class="nc" id="L53">            fileHandler.setFormatter(new MinimalFormatter());</span>
<span class="nc" id="L54">            consoleHandler = new ConsoleHandler();</span>
<span class="nc" id="L55">            consoleHandler.setFormatter(new MinimalFormatter());</span>
<span class="nc" id="L56">            LOGGER.addHandler(fileHandler);</span>
<span class="nc" id="L57">            LOGGER.addHandler(consoleHandler);</span>
<span class="nc" id="L58">            LOGGER.setLevel(Level.ALL);</span>
<span class="nc" id="L59">        } catch (Exception e) {</span>
<span class="nc" id="L60">            e.printStackTrace();</span>
<span class="nc" id="L61">        }</span>

<span class="nc" id="L63">        frame = new Frame(WIDTH, HEIGHT);</span>
<span class="nc" id="L64">        InputManager input = InputManager.getInstance();</span>
<span class="nc" id="L65">        frame.addKeyListener(input); // Register an instance to allow the window to receive keyboard event information</span>
<span class="nc" id="L66">        DrawManager.getInstance().setFrame(frame);</span>
<span class="nc" id="L67">        int width = frame.getWidth();</span>
<span class="nc" id="L68">        int height = frame.getHeight();</span>

<span class="nc" id="L70">        gameSettings = GameSettings.getGameSettings();</span>
<span class="nc" id="L71">        int NUM_LEVELS = gameSettings.size(); // Initialize total number of levels</span>


        // 2P mode: modified to null to allow for switch between 2 modes
<span class="nc" id="L75">        GameState gameState = null;</span>
<span class="nc" id="L76">        boolean coopSelected = false; // false = 1-player mode, true = 2-player mode</span>

<span class="nc" id="L78">        int returnCode = 1;</span>

<span class="nc" id="L80">        Ship.ShipType shipTypeP1 = Ship.ShipType.NORMAL; // Player 1 Ship Type</span>
<span class="nc" id="L81">        Ship.ShipType shipTypeP2 = Ship.ShipType.NORMAL; // Player 2 Ship Type</span>
        SystemData systemData;
        do {
            // Game Start
<span class="nc bnc" id="L85" title="All 9 branches missed.">            switch (returnCode) {</span>
                case 1:
                    // Title Screen
<span class="nc" id="L88">                    systemData = titleSystem(width, height);</span>
<span class="nc" id="L89">                    returnCode = systemData.returnCode;</span>
<span class="nc" id="L90">                    coopSelected = systemData.coopSelected;</span>
<span class="nc" id="L91">                    break;</span>
                case 2:
                    // In game screen
<span class="nc" id="L94">                    systemData = gamePlaySystem(width, height, coopSelected, shipTypeP1, shipTypeP2);</span>
<span class="nc" id="L95">                    coopSelected = systemData.coopSelected;</span>
<span class="nc" id="L96">                    shipTypeP1 = systemData.shipTypeP1;</span>
<span class="nc" id="L97">                    shipTypeP2 = systemData.shipTypeP2;</span>
<span class="nc" id="L98">                    returnCode = systemData.returnCode;</span>
<span class="nc" id="L99">                    LOGGER.info(&quot;Closing game screen.&quot;);</span>
<span class="nc" id="L100">                    break;</span>
                case 3:
                    // Achievement screen
<span class="nc" id="L103">                    returnCode = achievementSystem(width, height);</span>
<span class="nc" id="L104">                    LOGGER.info(&quot;Closing achievement screen.&quot;);</span>
<span class="nc" id="L105">                    break;</span>
                case 4:
                    // Setting screen
<span class="nc" id="L108">                    returnCode = settingSystem(width, height);</span>
<span class="nc" id="L109">                    LOGGER.info(&quot;Closing setting screen.&quot;);</span>
<span class="nc" id="L110">                    break;</span>
                case 5:
                    // Play mode selection screen about 1 player mode or 2 player mode
<span class="nc" id="L113">                    systemData = playModeSelectionSystem(width, height);</span>
<span class="nc" id="L114">                    returnCode = systemData.returnCode;</span>
<span class="nc" id="L115">                    coopSelected = systemData.coopSelected;</span>
<span class="nc" id="L116">                    LOGGER.info(&quot;Closing play screen.&quot;);</span>
<span class="nc" id="L117">                    break;</span>
                case 6:
                    // Ship selection for Player 1
<span class="nc" id="L120">                    systemData = shipSelectionSystem(width, height, 1, coopSelected);</span>
<span class="nc" id="L121">                    shipTypeP1 = systemData.shipTypeP1;</span>
<span class="nc" id="L122">                    returnCode = systemData.returnCode;</span>
<span class="nc" id="L123">                    LOGGER.info(&quot;Closing first player ship selection screen.&quot;);</span>
<span class="nc" id="L124">                    break;</span>
                case 7:
                    // Ship selection for Player 2
<span class="nc" id="L127">                    systemData = shipSelectionSystem(width, height, 2, coopSelected);</span>
<span class="nc" id="L128">                    shipTypeP2 = systemData.shipTypeP2;</span>
<span class="nc" id="L129">                    returnCode = systemData.returnCode;</span>
<span class="nc" id="L130">                    LOGGER.info(&quot;Closing second player ship selection screen.&quot;);</span>
<span class="nc" id="L131">                    break;</span>
                case 8:
                    // High score screen
<span class="nc" id="L134">                    returnCode = highScoreSystem(width, height);</span>
<span class="nc" id="L135">                    LOGGER.info(&quot;Closing high score screen.&quot;);</span>
<span class="nc" id="L136">                    break;</span>
                default:
                    break;
            }

<span class="nc bnc" id="L141" title="All 2 branches missed.">        } while (returnCode != 0);</span>

<span class="nc" id="L143">        fileHandler.flush();</span>
<span class="nc" id="L144">        fileHandler.close();</span>
<span class="nc" id="L145">        System.exit(0);</span>
<span class="nc" id="L146">    }</span>

    /**
     * Constructor, not called.
     */
    private Core() {

    }

    /**
     * Controls access to the logger.
     *
     * @return Application logger.
     */
    public static Logger getLogger() {
<span class="nc" id="L161">        return LOGGER;</span>
    }

    /**
     * Controls access to the draw manager.
     *
     * @return Application draw manager.
     */
    public static DrawManager getDrawManager() {
<span class="nc" id="L170">        return DrawManager.getInstance();</span>
    }

    /**
     * Controls access to the input manager.
     *
     * @return Application input manager.
     */
    public static InputManager getInputManager() {
<span class="nc" id="L179">        return InputManager.getInstance();</span>
    }

    /**
     * Controls access to the file manager.
     *
     * @return Application file manager.
     */
    public static FileManager getFileManager() {
<span class="nc" id="L188">        return FileManager.getInstance();</span>
    }

    /**
     * Controls access to the sound manager.
     *
     * @return Application sound manager.
     */
    public static SoundManager getSoundManager() {
<span class="nc" id="L197">        return SoundManager.getInstance();</span>
    }

    /**
     * Controls access to the asset manager.
     *
     * @return Application asset manager.
     */
    public static AssetManager getAssetManager() {
<span class="nc" id="L206">        return AssetManager.getInstance();</span>
    }

    /**
     * Controls access to the achievement manager.
     *
     * @return Application achievement manager.
     */
    public static AchievementManager getAchievementManager() {
<span class="nc" id="L215">        return AchievementManager.getInstance();</span>
    }

    /**
     * Controls access to the hitboxManager manager.
     *
     * @return Application hitboxManager manager.
     */
    public static HitboxManager getHitboxManager() {
<span class="nc" id="L224">        return HitboxManager.getInstance();</span>
    }

    /**
     * Controls creation of new cooldowns.
     *
     * @param milliseconds
     *                     Duration of the cooldown.
     * @return A new cooldown.
     */
    public static Cooldown getCooldown(final int milliseconds) {
<span class="fc" id="L235">        return new Cooldown(milliseconds);</span>
    }

    /**
     * Controls creation of new cooldowns with variance.
     *
     * @param milliseconds
     *                     Duration of the cooldown.
     * @param variance
     *                     Variation in the cooldown duration.
     * @return A new cooldown with variance.
     */
    public static Cooldown getVariableCooldown(final int milliseconds, final int variance) {
<span class="nc" id="L248">        return new Cooldown(milliseconds, variance);</span>
    }

<span class="fc" id="L251">    private static int volumeLevel = 50;</span>

    public static int getVolumeLevel() {
<span class="nc" id="L254">        return volumeLevel;</span>
    }

    public static void setVolumeLevel(int v) {
<span class="nc" id="L258">        volumeLevel = Math.max(0, Math.min(100, v));</span>
<span class="nc" id="L259">    }</span>

    // Class for screen system
    private static class SystemData {
        int returnCode;
        boolean coopSelected;
        Ship.ShipType shipTypeP1;
        Ship.ShipType shipTypeP2;

<span class="nc" id="L268">        public SystemData(int returnCode, boolean coopSelected, Ship.ShipType shipTypeP1, Ship.ShipType shipTypeP2) {</span>
<span class="nc" id="L269">            this.returnCode = returnCode;</span>
<span class="nc" id="L270">            this.coopSelected = coopSelected;</span>
<span class="nc" id="L271">            this.shipTypeP1 = shipTypeP1;</span>
<span class="nc" id="L272">            this.shipTypeP2 = shipTypeP2;</span>
<span class="nc" id="L273">        }</span>
    }

    /**
     * Activate title screen system.
     *
     * @param width
     *                     Title screen contents box width
     * @param height
     *                     Title screen contents box height
     * @return Next return code and coop selected
     */
    public static SystemData titleSystem(int width, int height) {
<span class="nc" id="L286">        SystemData systemData = new SystemData(0, false, null, null);</span>
<span class="nc" id="L287">        currentScreen = new TitleScreen(width, height, FPS);</span>
<span class="nc" id="L288">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT + &quot; title screen at &quot; + FPS + &quot; fps.&quot;);</span>
<span class="nc" id="L289">        systemData.returnCode = frame.setScreen(currentScreen);</span>
<span class="nc" id="L290">        LOGGER.info(&quot;Closing title screen.&quot;);</span>

<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (systemData.returnCode == 2) {</span>
<span class="nc" id="L293">            currentScreen = new PlayModeSelectionScreen(width, height, FPS);</span>
<span class="nc" id="L294">            systemData.returnCode = frame.setScreen(currentScreen);</span>
<span class="nc" id="L295">            systemData.coopSelected = ((PlayModeSelectionScreen) currentScreen).isCoopSelected();</span>
        }
<span class="nc" id="L297">        return systemData;</span>
    }

    /**
     * Activate achievement screen system.
     *
     * @param width
     *                     Achievement screen contents box width
     * @param height
     *                     Achievement screen contents box height
     * @return Next return code
     */
    public static int achievementSystem(int width, int height) {
<span class="nc" id="L310">        currentScreen = new AchievementScreen(width, height, FPS);</span>
<span class="nc" id="L311">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT</span>
                + &quot; achievements screen at &quot; + FPS + &quot; fps.&quot;);
<span class="nc" id="L313">        return frame.setScreen(currentScreen);</span>
    }

    /**
     * Activate ship selection screen system.
     *
     * @param width
     *                     Ship selection screen contents box width
     * @param height
     *                     Ship selection screen contents box height
     * @param coopSelected
     *                     2 player mode or not
     * @param shipTypeP1
     *                     Ship type of player 1
     * @param shipTypeP2
     *                     Ship type of player 2
     * @return Next return code and initial coop and ship type
     */
    public static SystemData gamePlaySystem(int width, int height, boolean coopSelected, Ship.ShipType shipTypeP1, Ship.ShipType shipTypeP2) throws IOException {
<span class="nc" id="L332">        SystemData systemData = new SystemData(0, coopSelected, shipTypeP1, shipTypeP2);</span>
<span class="nc" id="L333">        GameState gameState = new GameState(1, MAX_LIVES, coopSelected, 0);</span>
<span class="nc" id="L334">        AchievementManager achievementManager = new AchievementManager(); // 1p, 2p achievement manager</span>

        do {
<span class="nc bnc" id="L337" title="All 2 branches missed.">            int teamCap = gameState.isCoop() ? (MAX_LIVES * GameState.NUM_PLAYERS) : MAX_LIVES;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">            boolean bonusLife = gameState.getLevel() % EXTRA_LIFE_FREQUENCY == 0</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                    &amp;&amp; gameState.getLivesRemaining() &lt; teamCap;</span>

<span class="nc" id="L341">            currentScreen = new GameScreen(gameState, gameSettings.get(gameState.getLevel() - 1), bonusLife, width, height, FPS,</span>
                    shipTypeP1, shipTypeP2, achievementManager);

<span class="nc" id="L344">            LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT + &quot; game screen at &quot; + FPS + &quot; fps.&quot;);</span>
<span class="nc" id="L345">            systemData.returnCode = frame.setScreen(currentScreen);</span>
<span class="nc" id="L346">            LOGGER.info(&quot;Closing game screen.&quot;);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (systemData.returnCode == 1) {</span>
<span class="nc" id="L348">                break;</span>
            }

<span class="nc" id="L351">            gameState = ((GameScreen) currentScreen).getGameState();</span>

<span class="nc bnc" id="L353" title="All 2 branches missed.">            if (gameState.teamAlive()) {</span>
<span class="nc" id="L354">                gameState.nextLevel();</span>
            }

<span class="nc bnc" id="L357" title="All 4 branches missed.">        } while (gameState.teamAlive() &amp;&amp; gameState.getLevel() &lt;= gameSettings.size());</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (systemData.returnCode == 1) {</span>
<span class="nc" id="L360">            systemData.shipTypeP1 = Ship.ShipType.NORMAL;</span>
<span class="nc" id="L361">            systemData.shipTypeP2 = Ship.ShipType.NORMAL;</span>
<span class="nc" id="L362">            systemData.coopSelected = false;</span>
<span class="nc" id="L363">            return systemData;</span>
        }

<span class="nc" id="L366">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT + &quot; score screen at &quot; + FPS + &quot; fps, with a score of &quot;</span>
<span class="nc" id="L367">                + gameState.getScore() + &quot;, &quot;</span>
<span class="nc" id="L368">                + gameState.getLivesRemaining() + &quot; lives remaining, &quot;</span>
<span class="nc" id="L369">                + gameState.getBulletsShot() + &quot; bullets shot and &quot;</span>
<span class="nc" id="L370">                + gameState.getShipsDestroyed() + &quot; ships destroyed.&quot;);</span>
<span class="nc" id="L371">        currentScreen = new ScoreScreen(width, height, FPS, gameState, achievementManager);</span>
<span class="nc" id="L372">        systemData.returnCode = frame.setScreen(currentScreen);</span>

<span class="nc" id="L374">        return systemData;</span>
    }

    /**
     * Activate setting screen system.
     *
     * @param width
     *                     Setting screen contents box width
     * @param height
     *                     Setting screen contents box height
     * @return Next return code
     */
    public static int settingSystem(int width, int height) {
<span class="nc" id="L387">        currentScreen = new SettingScreen(width, height, FPS);</span>
<span class="nc" id="L388">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT</span>
                + &quot; setting screen at &quot; + FPS + &quot; fps.&quot;);
<span class="nc" id="L390">        frame.removeKeyListener(InputManager.getInstance());</span>
<span class="nc" id="L391">        frame.addKeyListener(InputManager.getInstance());</span>
<span class="nc" id="L392">        return frame.setScreen(currentScreen);</span>
    }

    /**
     * Activate play mode selection screen system.
     *
     * @param width
     *                     Play mode selection screen contents box width
     * @param height
     *                     Play mode selection screen contents box height
     * @return Next return code and coop selected
     */
    public static SystemData playModeSelectionSystem(int width, int height) {
        // Play : Use the play to decide 1p and 2p
<span class="nc" id="L406">        SystemData systemData = new SystemData(0, false, null, null);</span>
<span class="nc" id="L407">        currentScreen = new PlayModeSelectionScreen(width, height, FPS);</span>
<span class="nc" id="L408">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT + &quot; play screen at &quot; + FPS + &quot; fps.&quot;);</span>
<span class="nc" id="L409">        systemData.returnCode = frame.setScreen(currentScreen);</span>
<span class="nc" id="L410">        systemData.coopSelected = ((PlayModeSelectionScreen) currentScreen).isCoopSelected();</span>

        // Play screen -&gt; Ship selection screen
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (systemData.returnCode == 2) {</span>
<span class="nc" id="L414">            systemData.returnCode = 6;</span>
        }

<span class="nc" id="L417">        return systemData;</span>
    }

    /**
     * Activate ship selection screen system.
     *
     * @param width
     *                     Ship selection screen contents box width
     * @param height
     *                     Ship selection screen contents box height
     * @param player_num
     *                     Number of player count
     * @param coopSelected
     *                     2 player mode or not
     * @return Next return code
     */
    public static SystemData shipSelectionSystem(int width, int height, int player_num, boolean coopSelected) {
<span class="nc" id="L434">        SystemData systemData = new SystemData(0, coopSelected, null, null);</span>

<span class="nc" id="L436">        currentScreen = new ShipSelectionScreen(width, height, FPS, player_num);</span>
<span class="nc" id="L437">        systemData.returnCode = frame.setScreen(currentScreen);</span>
        // Ship selection for Player 1.
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (player_num == 1) {</span>
            // If clicked back button, go back to the screen 1P screen -&gt; Player select screen
<span class="nc bnc" id="L441" title="All 2 branches missed.">            if (systemData.returnCode == 5) {</span>
<span class="nc" id="L442">                return systemData;</span>
            }

<span class="nc" id="L445">            systemData.shipTypeP1 = ((ShipSelectionScreen) currentScreen).getSelectedShipType();</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">            if (coopSelected) {</span>
<span class="nc" id="L447">                systemData.returnCode = 7; // Go to Player 2 selection.</span>
            } else {
<span class="nc" id="L449">                systemData.returnCode = 2; // Start game.</span>
            }
        }

        // Ship selection for Player 2.
<span class="nc bnc" id="L454" title="All 2 branches missed.">        if (player_num == 2) {</span>
            // If clicked back button, go back to the screen 2P screen -&gt; 1P screen
<span class="nc bnc" id="L456" title="All 2 branches missed.">            if (systemData.returnCode == 6) {</span>
<span class="nc" id="L457">                return systemData;</span>
            }

<span class="nc" id="L460">            systemData.shipTypeP2 = ((ShipSelectionScreen) currentScreen).getSelectedShipType();</span>
<span class="nc" id="L461">            systemData.returnCode = 2; // Start game.</span>
        }

<span class="nc" id="L464">        return systemData;</span>
    }

    /**
     * Activate high score screen system.
     *
     * @param width
     *                     High score screen contents box width
     * @param height
     *                     High score screen contents box height
     * @return Next return code
     */
    public static int highScoreSystem(int width, int height) {
<span class="nc" id="L477">        currentScreen = new HighScoreScreen(width, height, FPS);</span>
<span class="nc" id="L478">        LOGGER.info(&quot;Starting &quot; + WIDTH + &quot;x&quot; + HEIGHT</span>
                + &quot; high score screen at &quot; + FPS + &quot; fps.&quot;);
<span class="nc" id="L480">        return frame.setScreen(currentScreen);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>