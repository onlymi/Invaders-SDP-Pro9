<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScoreScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">space_Invaders</a> &gt; <a href="index.source.html" class="el_package">screen</a> &gt; <span class="el_source">ScoreScreen.java</span></div><h1>ScoreScreen.java</h1><pre class="source lang-java linenums">package screen;

import java.awt.event.KeyEvent;
import java.io.IOException;
import java.util.*;

import engine.*;
import engine.gameplay.achievement.AchievementManager;
import engine.utils.Cooldown;

/**
 * Implements the score screen.
 *
 * @author &lt;a href=&quot;mailto:RobertoIA1987@gmail.com&quot;&gt;Roberto Izquierdo Amo&lt;/a&gt;
 *
 */
public class ScoreScreen extends Screen {

    /** Milliseconds between changes in user selection. */
    private static final int SELECTION_TIME = 200;
    /** Code of first mayus character. */
    private static final int FIRST_CHAR = 65;
    /** Code of last mayus character. */
    private static final int LAST_CHAR = 90;
    /** Code of max high score. */
    private static final int MAX_HIGH_SCORE_NUM = 7;
    /** Maximum name length. */
    private static final int MAX_NAME_LENGTH = 5;

    // Added for persist per-player breakdown
    private final GameState gameState;

    /** Current score. */
    private int score;
    /** Player lives left. */
    private int livesRemaining;
    /** Current coins. */
    private int coins;
    /** Total bullets shot by the player. */
    private int bulletsShot;
    /** Total ships destroyed by the player. */
    private int shipsDestroyed;
    /** List of past high scores. */
    private List&lt;Score&gt; highScores;
    /** Checks if current score is a new high score. */
    private boolean isNewRecord;
    /** Player name for record input. */
    private StringBuilder name;
    /** Character of players name selected for change. */
    private int nameCharSelected;
    /** Make sure the name is less than 3 characters. */
<span class="nc" id="L52">    private boolean showNameError = false;</span>
    /** Time between changes in user selection. */
    private Cooldown selectionCooldown;
    /** manages achievements.*/
    private AchievementManager achievementManager;
    /** Total coins earned in the game. */
<span class="nc" id="L58">    private int[] totalCoins = new int[2];</span>
    /** check 1P/2P mode; */
    private String mode;

    /**
     * Constructor, establishes the properties of the screen.
     *
     * @param width
     *                  Screen width.
     * @param height
     *                  Screen height.
     * @param fps
     *                  Frames per second, frame rate at which the game is run.
     * @param gameState
     *                  Current game state.
     * @param achievementManager
     * 			            Achievement manager instance used to track and save player achievements.
     * 			  2025-10-03  add generator parameter and comment
     */
    public ScoreScreen(final int width, final int height, final int fps,
                       final GameState gameState, final AchievementManager achievementManager) throws IOException {
<span class="nc" id="L79">        super(width, height, fps);</span>
<span class="nc" id="L80">        this.gameState = gameState;</span>

<span class="nc" id="L82">        this.score = gameState.getScore();</span>
<span class="nc" id="L83">        this.livesRemaining = gameState.getLivesRemaining();</span>
<span class="nc" id="L84">        this.coins = gameState.getCoins();</span>
<span class="nc" id="L85">        this.name = new StringBuilder();</span>
<span class="nc" id="L86">        this.bulletsShot = gameState.getBulletsShot();</span>
<span class="nc" id="L87">        this.shipsDestroyed = gameState.getShipsDestroyed();</span>
<span class="nc" id="L88">        this.totalCoins[0] = gameState.getCoins();</span>
<span class="nc" id="L89">        this.isNewRecord = false;</span>
<span class="nc" id="L90">        this.name = new StringBuilder();</span>
<span class="nc" id="L91">        this.nameCharSelected = 0;</span>
<span class="nc" id="L92">        this.selectionCooldown = Core.getCooldown(SELECTION_TIME);</span>
<span class="nc" id="L93">        this.selectionCooldown.reset();</span>
<span class="nc" id="L94">        this.achievementManager = achievementManager;</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">        this.mode = gameState.getCoop() ? &quot;2P&quot; : &quot;1P&quot;;</span>

        try {
<span class="nc" id="L98">            this.highScores = Core.getFileManager().loadHighScores(this.mode);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (highScores.size() &lt; MAX_HIGH_SCORE_NUM</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                    || highScores.get(highScores.size() - 1).getScore() &lt; this.score)</span>
<span class="nc" id="L101">                this.isNewRecord = true;</span>

<span class="nc" id="L103">        } catch (IOException e) {</span>
<span class="nc" id="L104">            LOGGER.warning(&quot;Couldn't load high scores!&quot;);</span>
<span class="nc" id="L105">        }</span>
        // clear last key
<span class="nc" id="L107">        inputManager.clearLastKey();</span>
<span class="nc" id="L108">    }</span>

    /**
     * Starts the action.
     *
     * @return Next screen code.
     */
    public final int run() {
<span class="nc" id="L116">        super.run();</span>

<span class="nc" id="L118">        return this.returnCode;</span>
    }

    /**
     * Updates the elements on screen and checks for events.
     */
    protected final void update() {
<span class="nc" id="L125">        super.update();</span>

<span class="nc" id="L127">		draw();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">		if (this.inputDelay.checkFinished()) {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (inputManager.isKeyDown(KeyEvent.VK_ESCAPE)) {</span>
                // Return to main menu.
<span class="nc" id="L131">                SoundManager.playOnce(&quot;select&quot;);</span>
<span class="nc" id="L132">				this.returnCode = 1;</span>
<span class="nc" id="L133">				this.isRunning = false;</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">				if (this.isNewRecord) {</span>
<span class="nc" id="L135">					saveScore();</span>
<span class="nc" id="L136">					saveAchievement(); //2025-10-03 call method for save achievement released</span>
				}
<span class="nc bnc" id="L138" title="All 2 branches missed.">			} else if (inputManager.isKeyDown(KeyEvent.VK_SPACE)) {</span>
                // name too short -&gt; return
<span class="nc bnc" id="L140" title="All 2 branches missed.">                if (this.name.length() &lt; 3) return;</span>
				// Play again.
<span class="nc" id="L142">                SoundManager.playOnce(&quot;select&quot;);</span>
<span class="nc" id="L143">				this.returnCode = 2;</span>
<span class="nc" id="L144">				this.isRunning = false;</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">				if (this.isNewRecord) {</span>
<span class="nc" id="L146">					saveScore();</span>
<span class="nc" id="L147">					saveAchievement(); // 2025-10-03 call method for save achievement released</span>
				}
			}

			// Handle backspace
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (inputManager.isKeyDown(KeyEvent.VK_BACK_SPACE)</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">					&amp;&amp; this.selectionCooldown.checkFinished()) {</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">				if (this.name.length() &gt; 0) {</span>
<span class="nc" id="L155">					this.name.deleteCharAt(this.name.length() - 1);</span>
<span class="nc" id="L156">					this.selectionCooldown.reset();</span>
				}
			}

			// Handle character input
<span class="nc" id="L161">			char typedChar = inputManager.getLastCharTyped();</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (typedChar != '\0') {</span>
				// Checks the name is not short when you press the space bar
<span class="nc bnc" id="L164" title="All 2 branches missed.">				if (typedChar == ' ') {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">					if (this.name.length() &lt; 3) {</span>
						// System.out.println(&quot;too short!!&quot;);
<span class="nc" id="L167">						this.showNameError = true;</span>
					}
				}

				// Check if it's a valid character (alphanumeric only)
<span class="nc bnc" id="L172" title="All 2 branches missed.">				else if ((Character.isLetterOrDigit(typedChar))</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">						&amp;&amp; this.name.length() &lt; MAX_NAME_LENGTH) {</span>
<span class="nc" id="L174">					this.name.append(Character.toUpperCase(typedChar));</span>

				}
			}
		}

<span class="nc" id="L180">    }</span>

    /**
     * Saves the score as a high score.
     * 2025-10-18
     * Add ability that distinguish duplicate names and save higher scores
     */
    private void saveScore() {
<span class="nc bnc" id="L188" title="All 4 branches missed.">        String mode = (gameState != null &amp;&amp; gameState.isCoop()) ? &quot;2p&quot; : &quot;1p&quot;;</span>
<span class="nc" id="L189">        String newName = new String(this.name);</span>
<span class="nc" id="L190">        Score newScore = new Score(newName, this.gameState, mode);</span>
<span class="nc" id="L191">        boolean foundAndReplaced = false;</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        for (int i = 0; i &lt; highScores.size(); i++) {</span>
<span class="nc" id="L193">            Score existingScore = highScores.get(i);</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (existingScore.getName().equals(newName)) {</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">                if (newScore.getScore() &gt; existingScore.getScore()) {</span>
<span class="nc" id="L196">                    highScores.set(i, newScore);</span>
<span class="nc" id="L197">                    foundAndReplaced = true;</span>
                } else {
<span class="nc" id="L199">                    foundAndReplaced = true;</span>
                }
<span class="nc" id="L201">                break;</span>
            }
        }
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (!foundAndReplaced) {</span>
<span class="nc" id="L205">            highScores.add(newScore);</span>
        }
<span class="nc" id="L207">        Collections.sort(highScores);</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">        if (highScores.size() &gt; MAX_HIGH_SCORE_NUM)</span>
<span class="nc" id="L209">            highScores.remove(highScores.size() - 1);</span>
        try {
<span class="nc" id="L211">            Core.getFileManager().saveHighScores(highScores, mode);</span>
<span class="nc" id="L212">        } catch (IOException e) {</span>
<span class="nc" id="L213">            LOGGER.warning(&quot;Couldn't load high scores!&quot;);</span>
<span class="nc" id="L214">        }</span>
<span class="nc" id="L215">    }</span>

    /**
     * Save the achievement released.
     * 2025-10-03
     * add new method
     */
    private void saveAchievement() {
        try {
<span class="nc" id="L224">            this.achievementManager.saveToFile(new String(this.name), this.mode);</span>
<span class="nc" id="L225">        } catch (IOException e) {</span>
<span class="nc" id="L226">            LOGGER.warning(&quot;Couldn't save achievements!&quot;);</span>
<span class="nc" id="L227">        }</span>
<span class="nc" id="L228">    }</span>

    /**
     * Draws the elements associated with the screen.
     */
    private void draw() {
<span class="nc" id="L234">        drawManager.initDrawing(this);</span>

<span class="nc" id="L236">		drawManager.getScoreScreenRenderer().drawGameOver(drawManager.getBackBufferGraphics(), this, this.inputDelay.checkFinished());</span>

<span class="nc bnc" id="L238" title="All 2 branches missed.">        float accuracy = (this.bulletsShot &gt; 0)</span>
<span class="nc" id="L239">                ? (float) this.shipsDestroyed / this.bulletsShot</span>
<span class="nc" id="L240">                : 0f;</span>

		// 2P mode: edit to include co-op + individual score/coins
<span class="nc bnc" id="L243" title="All 4 branches missed.">		if (this.gameState != null &amp;&amp; this.gameState.isCoop()) {</span>
			// team summary
<span class="nc" id="L245">			drawManager.getScoreScreenRenderer().drawResults(drawManager.getBackBufferGraphics(), this,</span>
<span class="nc" id="L246">                    this.gameState.getScore(),</span>
<span class="nc" id="L247">                    this.gameState.getCoins(),</span>
<span class="nc" id="L248">					this.gameState.getLivesRemaining(),</span>
<span class="nc" id="L249">					this.gameState.getShipsDestroyed(),</span>
					0f, // Leaving out team accuracy
                    this.isNewRecord,
                    false // Draw accuracy for 2P mode
			);

            // show per-player lines when in 2P mode

<span class="nc bnc" id="L257" title="All 2 branches missed.">            float p1Acc = this.gameState.getBulletsShot(0) &gt; 0 ? (float) this.gameState.getShipsDestroyed(0) / this.gameState.getBulletsShot(0) : 0f;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            float p2Acc = this.gameState.getBulletsShot(1) &gt; 0 ? (float) this.gameState.getShipsDestroyed(1) / this.gameState.getBulletsShot(1) : 0f;</span>

<span class="nc" id="L260">            String p1 = String.format(&quot;P1  %04d  |  acc %.2f%%&quot;, this.gameState.getScore(0), p1Acc * 100f);</span>
<span class="nc" id="L261">            String p2 = String.format(&quot;P2  %04d  |  acc %.2f%%&quot;, this.gameState.getScore(1), p2Acc * 100f);</span>

            int y;  // tweak these if you want
<span class="nc bnc" id="L264" title="All 2 branches missed.">            if (this.isNewRecord) {</span>
<span class="nc" id="L265">                y = this.getHeight() / 2 + 40; // Position if new record is True</span>
            } else {
<span class="nc" id="L267">                y = this.getHeight() / 2 + 80; // Position if new record is False</span>
            }
<span class="nc" id="L269">            drawManager.getCommonRenderer().drawCenteredRegularString(drawManager.getBackBufferGraphics(), this, p1, y);</span>
<span class="nc" id="L270">            drawManager.getCommonRenderer().drawCenteredRegularString(drawManager.getBackBufferGraphics(), this, p2, y + 20); // Increase spacing</span>

<span class="nc" id="L272">		} else {</span>
			// 1P legacy summary with accuracy
<span class="nc bnc" id="L274" title="All 2 branches missed.">			float acc = (this.bulletsShot &gt; 0) ? (float) this.shipsDestroyed / this.bulletsShot : 0f;</span>
<span class="nc" id="L275">            drawManager.getScoreScreenRenderer().drawResults(drawManager.getBackBufferGraphics(), this, this.score, this.coins, this.livesRemaining, this.shipsDestroyed, acc, this.isNewRecord, true); // Draw accuracy for 1P mode</span>
		}


<span class="nc" id="L279">		drawManager.getScoreScreenRenderer().drawNameInput(drawManager.getBackBufferGraphics(), this, this.name, this.isNewRecord);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">		if (showNameError)</span>
<span class="nc" id="L281">			drawManager.getScoreScreenRenderer().drawNameInputError(drawManager.getBackBufferGraphics(), this);</span>

<span class="nc" id="L283">        drawManager.completeDrawing(this);</span>
<span class="nc" id="L284">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>